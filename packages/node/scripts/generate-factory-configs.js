const fs = require('fs/promises');
const path = require('path');
const yaml = require('yaml');
const {
  allChecks,
  recommended,
  CheckDefinition,
  ChecksSettings,
  SourceCodeType,
} = require('@shopify/theme-check-common');

const destination = path.resolve(__dirname, '..', 'configs');

const autogeneratedWarning = `# WARNING:
# This file was generated automatically by running "scripts/generate-factory-configs"
# Do not modify manually. Your changes will be overwritten.
`;

const alphabetically = (a, b) => {
  return a.meta.code < b.meta.code ? -1 : a.meta.code > b.meta.code ? 1 : 0;
};

/**
 * @param checkDefs {CheckDefinition<SourceCodeType>[]}
 */
function asYaml(checkDefs) {
  const checkSettings = {
    ignore: ['node_modules/**'],
  };

  for (const checkDef of checkDefs.sort(alphabetically)) {
    const { code, schema } = checkDef.meta;
    checkSettings[code] = {
      enabled: true,
      severity: checkDef.meta.severity,
    };

    for (const [key, schemaProp] of Object.entries(schema)) {
      checkSettings[code][key] = schemaProp.defaultValue();
    }
  }

  return autogeneratedWarning + yaml.stringify(checkSettings);
}

async function run() {
  await fs.writeFile(path.join(destination, 'all.yml'), asYaml(allChecks));
  await fs.writeFile(path.join(destination, 'recommended.yml'), asYaml(recommended));
}

async function main() {
  let statusCode = 0;
  try {
    await run();
  } catch (e) {
    console.log(e);
    statusCode = 1;
  }
  process.exit(statusCode);
}

main();
